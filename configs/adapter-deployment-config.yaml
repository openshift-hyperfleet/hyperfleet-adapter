# HyperFleet Adapter Deployment Configuration
#
# This file contains ONLY infrastructure and deployment-related settings:
#   - Client connections (Maestro, HyperFleet API, Kubernetes)
#   - Authentication and TLS configuration
#   - Connection timeouts and retry policies
#
# NOTE: This is a SAMPLE configuration file for reference and local development.
# It is NOT automatically packaged with the container image (see Dockerfile).
#
# In production, provide configuration via one of these methods:
#   1. ADAPTER_CONFIG_PATH environment variable pointing to a config file (highest priority)
#   2. ConfigMap mounted at /etc/adapter/config/adapter-deployment-config.yaml
#
# Example Kubernetes deployment:
#   env:
#     - name: ADAPTER_CONFIG_PATH
#       value: /etc/adapter/config/adapter-deployment-config.yaml
#   volumeMounts:
#     - name: config
#       mountPath: /etc/adapter/config
#
# For business logic configuration (params, preconditions, resources, post-actions),
# use a separate business config file. See configs/adapter-config-template.yaml

apiVersion: hyperfleet.redhat.com/v1alpha1
kind: AdapterConfig
metadata:
  name: hyperfleet-adapter
  labels:
    hyperfleet.io/component: adapter

spec:
  adapter:
    version: "0.1.0"

  # Log the full merged configuration after load (default: false)
  # Environment variable: HYPERFLEET_DEBUG_CONFIG
  # Flag: --debug-config
  debugConfig: false

  # Client configurations for external services
  clients:
    # Maestro transport client configuration
    maestro:
      # gRPC server address
      # Environment variable: HYPERFLEET_MAESTRO_GRPC_SERVER_ADDRESS
      # Flag: --maestro-grpc-server-address
      grpcServerAddress: "maestro-grpc.maestro.svc.cluster.local:8090"
      
      # HTTPS server address for REST API operations (optional)
      # Environment variable: HYPERFLEET_MAESTRO_HTTP_SERVER_ADDRESS
      httpServerAddress: "https://maestro-api.maestro.svc.cluster.local"
      
      # Source identifier for CloudEvents routing (must be unique across adapters)
      # Environment variable: HYPERFLEET_MAESTRO_SOURCE_ID
      sourceId: "hyperfleet-adapter"
      
      # Client identifier (defaults to sourceId if not specified)
      # Environment variable: HYPERFLEET_MAESTRO_CLIENT_ID
      clientId: "hyperfleet-adapter-client"
      
      # Authentication configuration
      auth:
        type: "tls"  # TLS certificate-based mTLS
        
        tlsConfig:
          # gRPC TLS configuration
          # Certificate paths (mounted from Kubernetes secrets)
          # Environment variable: HYPERFLEET_MAESTRO_CA_FILE
          caFile: "/etc/maestro/certs/grpc/ca.crt"
          
          # Environment variable: HYPERFLEET_MAESTRO_CERT_FILE
          certFile: "/etc/maestro/certs/grpc/client.crt"
          
          # Environment variable: HYPERFLEET_MAESTRO_KEY_FILE
          keyFile: "/etc/maestro/certs/grpc/client.key"
          
          # Server name for TLS verification
          # Environment variable: HYPERFLEET_MAESTRO_SERVER_NAME
          serverName: "maestro-grpc.maestro.svc.cluster.local"
          
          # HTTP API TLS configuration (may use different CA than gRPC)
          # If not set, falls back to caFile for backwards compatibility
          # Environment variable: HYPERFLEET_MAESTRO_HTTP_CA_FILE
          httpCaFile: "/etc/maestro/certs/https/ca.crt"
      
      # Connection settings
      timeout: "30s"
      retryAttempts: 3
      retryBackoff: "exponential"
      
      # Keep-alive for long-lived gRPC connections
      keepalive:
        time: "30s"
        timeout: "10s"
        permitWithoutStream: true
    
    # HyperFleet HTTP API client
    hyperfleetApi:
      baseUrl: http://hyperfleet-api:8000
      version: v1
      timeout: 2s
      retryAttempts: 3
      retryBackoff: exponential
    
    # Broker consumer configuration (adapter-level)
    broker:
      subscriptionId: "amarin-ns1-clusters-validation-gcp-adapter"
      topic: "amarin-ns1-clusters"

    # Kubernetes client (for direct K8s resources)
    kubernetes:
      apiVersion: "v1"
      # Uses in-cluster service account by default
      # Set kubeConfigPath for out-of-cluster access
      kubeConfigPath: PATH_TO_KUBECONFIG_FILE
      # Optional rate limits (0 uses defaults)
      qps: 100
      burst: 200
